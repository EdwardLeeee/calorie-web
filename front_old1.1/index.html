<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>每日卡路里紀錄</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="stylesheet" href="styles.css?v=3" />

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>

<body>
  <!-- Vue 根節點 -->
  <div id="app">
    <header class="app-header">
      <h1>每日卡路里</h1>
      <button v-if="isLoggedIn" class="btn logout-btn" @click="doLogout">登出</button>
    </header>

    <main class="main-content">
      <router-view></router-view>
    </main>

    <!-- Modal -->
    <div v-if="isModalVisible" class="modal-overlay" @click.self="closeModal">
      <div class="modal-card">
        <div class="modal-header">
          <h3>食物詳細資訊</h3>
          <button @click="closeModal" class="close-btn">&times;</button>
        </div>
        <div class="modal-body" v-if="modalFoodDetails">
          <table class="details-table">
            <tbody>
              <tr><td>食物名稱</td><td>{{ modalFoodDetails.name }}</td></tr>
              <tr><td>熱量</td><td>{{ modalFoodDetails.calories.toFixed(0) }} kcal</td></tr>
              <tr><td>碳水化合物</td><td>{{ modalFoodDetails.carbs.toFixed(1) }} g</td></tr>
              <tr><td>蛋白質</td><td>{{ modalFoodDetails.protein.toFixed(1) }} g</td></tr>
              <tr><td>脂肪</td><td>{{ modalFoodDetails.fat.toFixed(1) }} g</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- /#app -->

  <!-- 登入模板 -->
  <template id="login-template">
    <div class="auth-container">
      <div class="auth-card">
        <h2 class="card-title">登入</h2>
        <p v-if="message" class="message">{{ message }}</p>

        <input type="text" name="fakeuser" style="display:none"/>
        <input type="password" name="fakepass" style="display:none"/>

        <form @submit.prevent="doLogin" autocomplete="off">
          <div class="form-group">
            <label>帳號</label>
            <input v-model="username" class="input" placeholder="請輸入帳號" required autocomplete="new-username"/>
          </div>
          <div class="form-group">
            <label>密碼</label>
            <input 
              type="password"
              v-model="password"
              autocomplete="new-password"
              placeholder="請輸入密碼"
                   />
          </div>
          <button class="btn primary full-width">登入</button>
        </form>
        <p class="small-text">沒有帳號？<router-link to="/signup">立刻註冊</router-link></p>
      </div>
    </div>
  </template>

  <!-- 註冊模板 -->
  <template id="signup-template">
    <div class="auth-container">
      <div class="auth-card">
        <h2 class="card-title">註冊</h2>
        <p v-if="message" class="message">{{ message }}</p>

        <input type="text" name="fakeuser" style="display:none"/>
        <input type="password" name="fakepass" style="display:none"/>

        <form @submit.prevent="doSignup" autocomplete="off">
          <div class="form-group">
            <label>帳號</label>
            <input v-model="username" class="input" placeholder="請輸入帳號" required autocomplete="new-username"/>
          </div>
          <div class="form-group">
            <label>密碼</label>
            <input v-model="password" type="password" class="input"
                   placeholder="請輸入密碼" required readonly @focus="removeReadonly"/>
          </div>
          <button class="btn primary full-width">註冊</button>
        </form>
        <p class="small-text">已有帳號？<router-link to="/login">返回登入</router-link></p>
      </div>
    </div>
  </template>

  <!-- Dashboard 模板 -->
  <template id="dashboard-template">
    <div class="main-content">
      <div class="dashboard-charts">
        <div class="chart-container">
          <svg viewBox="0 0 120 120" class="waterball-svg">
            <circle cx="60" cy="60" r="54" fill="#eee"/>
            <circle
              cx="60" cy="60" r="54" fill="transparent"
              stroke-width="12" :stroke="circleColor"
              stroke-linecap="round" transform="rotate(-90 60 60)"
              :stroke-dasharray="circumference"
              :stroke-dashoffset="circumference * (1 - kcalRatio)"/>
            <text x="60" y="60" text-anchor="middle" dominant-baseline="middle" class="chart-text-lg">
              {{ todayCalories.toFixed(0) }}
            </text>
            <text x="60" y="80" text-anchor="middle" dominant-baseline="middle" class="chart-text-sm">
              / {{ targetKcal }} kcal
            </text>
          </svg>
          <div class="target-input-group">
            <label for="target-kcal">目標大卡：</label>
            <input id="target-kcal" type="number" v-model.number="targetKcal" class="target-input"/>
          </div>
        </div>
        <div class="chart-container">
          <!-- 1. 圓餅圖 -->
          <svg width="120" height="120" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="54" fill="#eee"/>
            <path v-if="macroAngles.carbs>0"
                  :d="pieSlicePath(0,macroAngles.carbs,54)"
                  fill="#8BC34A"/>
            <path v-if="macroAngles.protein>0"
                  :d="pieSlicePath(macroAngles.carbs,macroAngles.carbs+macroAngles.protein,54)"
                  fill="#2196F3"/>
            <path v-if="macroAngles.fat>0"
                  :d="pieSlicePath(macroAngles.carbs+macroAngles.protein,360,54)"
                  fill="#FFC107"/>
            <circle cx="60" cy="60" r="30" fill="#fff"/>
          </svg>
          
          <div class="macro-legend">
            <div class="legend-item">
              <span class="legend-color carb-color"></span>
              碳水化合物 ({{ macroPercents.carbs }}%) {{ todayCarbs.toFixed(1) }}g
            </div>
            <div class="legend-item">
              <span class="legend-color protein-color"></span>
              蛋白質 ({{ macroPercents.protein }}%) {{ todayProtein.toFixed(1) }}g
            </div>
            <div class="legend-item">
              <span class="legend-color fat-color"></span>
              脂肪 ({{ macroPercents.fat }}%) {{ todayFat.toFixed(1) }}g
            </div>
          </div>
        </div>
      </div>

      <div class="list-container">
        <div class="list-header">
          <h3>今天的飲食紀錄</h3>
          <button class="btn link-btn" @click="goToAllRecords">查看更多</button>
        </div>
        <div v-if="todayRecords.length>0" class="data-table">
          <div class="table-header">
            <div class="table-cell cell-name">食物名稱 (熱量)</div>
            <div class="table-cell cell-info">時間</div>
            <div class="table-cell cell-actions">操作</div>
          </div>
          <div v-for="r in todayRecords" :key="r.id" class="table-row">
            <div class="table-cell cell-name food-name-clickable"
                 @click="showFoodDetails(r)">
              {{ getRecordLabel(r) }}
            </div>
            <div class="table-cell cell-info">{{ formatTime(r.record_time) }}</div>
            <div class="table-cell cell-actions">
              <button class="btn small-btn info-btn" @click="editRecord(r)">編輯</button>
              <button class="btn small-btn danger-btn" @click="deleteRecord(r.id)">刪除</button>
            </div>
          </div>
        </div>
        <div v-else class="no-data"><p>今天尚無紀錄，點此新增</p></div>
      </div>

      <button class="btn add-btn" @click="$router.push('/add-record')">+</button>

      <nav class="bottom-nav">
        <div class="nav-item"
             :class="{active:$route.path==='/' }"
             @click="$router.push('/')">
          <i class="fas fa-chart-pie icon"></i>
          <span>儀表板</span>
        </div>
        <div class="nav-item"
             :class="{active:$route.path==='/add-record'}"
             @click="$router.push('/add-record')">
          <i class="fas fa-plus-circle icon"></i>
          <span>新增紀錄</span>
        </div>
        <div class="nav-item"
             :class="{active:$route.path==='/custom-foods'}"
             @click="$router.push('/custom-foods')">
          <i class="fas fa-utensils icon"></i>
          <span>自訂食物</span>
        </div>
      </nav>
    </div>
  </template>

  <!-- 新增 / 編輯飲食紀錄模板 -->
  <template id="add-record-template">
    <div class="add-record-container">
      <div class="page-header">
        <button class="btn link-btn back-btn" @click="$router.back()">←</button>
        <h2>{{ editing?'編輯飲食紀錄':'新增飲食紀錄' }}</h2>
      </div>
      <div class="form-page-container">
        <div class="form-card">
          <form @submit.prevent="submitRecord" autocomplete="off">
            <div class="form-group">
              <label>模式：</label>
              <select v-model="inputMode" required>
                <option value="official">官方食物</option>
                <option value="custom">自訂食物</option>
                <option value="manual">手動輸入</option>
              </select>
            </div>
            <div v-if="inputMode==='official'" class="form-group">
              <label for="official_food_id">官方食物</label>
              <select id="official_food_id"
                      v-model.number="form.official_food_id"
                      @change="onOfficialChange"
                      required>
                <option disabled value="">請選擇</option>
                <option v-for="of in officialFoods" :key="of.id" :value="of.id">
                  {{ of.name }} ({{ of.calories }} kcal)
                </option>
              </select>
            </div>
            <div v-if="inputMode==='custom'" class="form-group">
              <label for="custom_food_id">自訂食物</label>
              <select id="custom_food_id"
                      v-model.number="form.custom_food_id"
                      @change="onCustomChange"
                      required>
                <option disabled value="">請選擇</option>
                <option v-for="cf in customFoods" :key="cf.id" :value="cf.id">
                  {{ cf.name }} ({{ cf.calories }} kcal)
                </option>
              </select>
            </div>
            <div v-if="inputMode==='manual'" class="form-group">
              <label for="manual_name">食物名稱</label>
              <input id="manual_name" type="text"
                     v-model="form.manual_name"
                     placeholder="自訂名稱"
                     required/>
            </div>
            <div class="form-group">
              <label for="qty">份量</label>
              <input id="qty" type="number"
                     v-model.number="form.qty"
                     min="0.1" step="0.1"
                     required/>
            </div>
            <div class="form-group">
              <label for="record_time">時間</label>
              <input id="record_time" type="datetime-local"
                     v-model="form.record_time" required/>
            </div>
            <div class="form-group">
              <label for="calorie_sum">熱量 (kcal)</label>
              <input id="calorie_sum" type="number" step="0.01"
                     v-model.number="form.calorie_sum"
                     :readonly="inputMode!=='manual'"
                     required/>
            </div>
            <div class="form-group">
              <label for="carb_sum">碳水化合物 (g)</label>
              <input id="carb_sum" type="number" step="0.01"
                     v-model.number="form.carb_sum"
                     :readonly="inputMode!=='manual'"
                     required/>
            </div>
            <div class="form-group">
              <label for="protein_sum">蛋白質 (g)</label>
              <input id="protein_sum" type="number" step="0.01"
                     v-model.number="form.protein_sum"
                     :readonly="inputMode!=='manual'"
                     required/>
            </div>
            <div class="form-group">
              <label for="fat_sum">脂肪 (g)</label>
              <input id="fat_sum" type="number" step="0.01"
                     v-model.number="form.fat_sum"
                     :readonly="inputMode!=='manual'"
                     required/>
            </div>
            <div class="form-actions">
              <button class="btn primary full-width">
                {{ editing?'更新':'新增' }}
              </button>
            </div>
          </form>
        </div>
      </div>
      <div v-if="error" class="error">{{ error }}</div>
      <nav class="bottom-nav">
        <div class="nav-item" :class="{active:$route.path==='/' }" @click="$router.push('/')">
          <i class="fas fa-chart-pie icon"></i><span>儀表板</span>
        </div>
        <div class="nav-item" :class="{active:$route.path==='/add-record'}" @click="$router.push('/add-record')">
          <i class="fas fa-plus-circle icon"></i><span>新增紀錄</span>
        </div>
        <div class="nav-item" :class="{active:$route.path==='/custom-foods'}" @click="$router.push('/custom-foods')">
          <i class="fas fa-utensils icon"></i><span>自訂食物</span>
        </div>
      </nav>
    </div>
  </template>

  <!-- 全部紀錄模板 -->
  <template id="all-records-template">
    <div class="main-content">
      <div class="page-header">
        <router-link to="/" class="back-btn">←</router-link>
        <h2>全部飲食紀錄</h2>
      </div>
      <div class="filter-bar">
      <div class="filter-group">
        <label for="start-date">從：</label>
        <input type="date" id="start-date" v-model="startDate" />
      </div>
      <div class="filter-group">
        <label for="end-date">到：</label>
        <input type="date" id="end-date" v-model="endDate" />
      </div>
      <button class="btn primary small-btn" @click="applyFilter">查詢</button>
      <button class="btn small-btn" @click="clearFilter">清除</button>
    </div>
      <div v-if="records.length>0">
        <div v-for="(group,date) in groupedRecords" :key="date" class="list-container all-records-group">
          <div class="group-header">{{ date }} ({{ weekdayOf(date) }})</div>
          <div class="data-table">
            <div class="table-header">
              <div class="table-cell cell-name">食物名稱 (熱量)</div>
              <div class="table-cell cell-info">時間</div>
              <div class="table-cell cell-actions">操作</div>
            </div>
            <div v-for="r in group" :key="r.id" class="table-row">
              <div class="table-cell cell-name food-name-clickable"
                   @click="showFoodDetails(r)">
                {{ getRecordLabel(r) }}
              </div>
              <div class="table-cell cell-info">{{ formatTime(r.record_time) }}</div>
              <div class="table-cell cell-actions">
                <button class="btn small-btn info-btn" @click="editRecord(r)">編輯</button>
                <button class="btn small-btn danger-btn" @click="deleteRecord(r.id)">刪除</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else class="no-data"><p>目前沒有任何紀錄</p></div>
      <nav class="bottom-nav">
        <div class="nav-item" :class="{active:$route.path==='/' }" @click="$router.push('/')">
          <i class="fas fa-chart-pie icon"></i><span>儀表板</span>
        </div>
        <div class="nav-item" :class="{active:$route.path==='/add-record'}" @click="$router.push('/add-record')">
          <i class="fas fa-plus-circle icon"></i><span>新增紀錄</span>
        </div>
        <div class="nav-item" :class="{active:$route.path==='/custom-foods'}" @click="$router.push('/custom-foods')">
          <i class="fas fa-utensils icon"></i><span>自訂食物</span>
        </div>
      </nav>
    </div>
  </template>

  <!-- 自訂食物模板 -->
  <template id="custom-foods-template">
    <div class="main-content">
      <div class="page-header">
        <router-link to="/" class="back-btn">←</router-link>
        <h2>自訂食物</h2>
      </div>
      <div v-if="foods.length>0" class="list-container custom-foods-table">
        <div class="data-table">
          <div class="table-header">
            <div class="table-cell cell-name">食物名稱 (熱量)</div>  
            <div class="table-cell cell-actions">操作</div>
          </div>
          <div v-for="f in foods" :key="f.id" class="table-row">
            <div class="table-cell cell-name">{{ getFoodLabel(f) }}</div>
            <div class="table-cell cell-actions">
              <button class="btn small-btn info-btn" @click="editFood(f)">編輯</button>
              <button class="btn small-btn danger-btn" @click="deleteFood(f.id)">刪除</button>
            </div>
          </div>
        </div>
      </div>
      <div v-else class="no-data"><p>目前尚無自訂食物</p></div>
      <button class="btn add-btn" @click="goToAddFood">+</button>
      <nav class="bottom-nav">
        <div class="nav-item" :class="{active:$route.path==='/' }" @click="$router.push('/')">
          <i class="fas fa-chart-pie icon"></i><span>儀表板</span>
        </div>
        <div class="nav-item" :class="{active:$route.path==='/add-record'}" @click="$router.push('/add-record')">
          <i class="fas fa-plus-circle icon"></i><span>新增紀錄</span>
        </div>
        <div class="nav-item" :class="{active:$route.path==='/custom-foods'}" @click="$router.push('/custom-foods')">
          <i class="fas fa-utensils icon"></i><span>自訂食物</span>
        </div>
      </nav>
    </div>
  </template>

  <!-- 新增 / 編輯自訂食物模板 -->
  <template id="add-food-template">
    <div class="custom-foods-container">
      <div class="page-header">
        <button class="btn link-btn back-btn" @click="$router.back()">←</button>
        <h2>{{ editing?'編輯自訂食物':'新增自訂食物' }}</h2>
      </div>
      <div class="form-page-container">
        <div class="form-card">
          <form @submit.prevent="submitFood" autocomplete="off">
            <div class="form-group">
              <label for="name">名稱</label>
              <input id="name" v-model="form.name" type="text" required placeholder="食物名稱"/>
            </div>
            <div class="form-group">
              <label for="calories">卡路里 (kcal)</label>
              <input id="calories" v-model.number="form.calories" type="number" step="0.01" required placeholder="例如：165"/>
            </div>
            <div class="form-group">
              <label for="carbs">碳水 (g)</label>
              <input id="carbs" v-model.number="form.carbs" type="number" step="0.01" required placeholder="例如：6.6"/>
            </div>
            <div class="form-group">
              <label for="protein">蛋白質 (g)</label>
              <input id="protein" v-model.number="form.protein" type="number" step="0.01" required placeholder="例如：31"/>
            </div>
            <div class="form-group">
              <label for="fat">脂肪 (g)</label>
              <input id="fat" v-model.number="form.fat" type="number" step="0.01" required placeholder="例如：3.6"/>
            </div>
            <div class="form-actions">
              <button class="btn primary full-width">{{ editing?'更新':'送出' }}</button>
            </div>
          </form>
        </div>
      </div>
      <div v-if="error" class="error">{{ error }}</div>
      <nav class="bottom-nav">
        <div class="nav-item" :class="{active:$route.path==='/' }" @click="$router.push('/')">
          <i class="fas fa-chart-pie icon"></i><span>儀表板</span>
        </div>
        <div class="nav-item" :class="{active:$route.path==='/add-record'}" @click="$router.push('/add-record')">
          <i class="fas fa-plus-circle icon"></i><span>新增紀錄</span>
        </div>
        <div class="nav-item" :class="{active:$route.path==='/custom-foods'}" @click="$router.push('/custom-foods')">
          <i class="fas fa-utensils icon"></i><span>自訂食物</span>
        </div>
      </nav>
    </div>
  </template>

  <!-- 引入 app.js -->
  <script src="app.js?v=3.1"></script>
</body>
</html>

