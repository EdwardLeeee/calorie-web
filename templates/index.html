<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Food ç®¡ç†</title>
  <style>
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; }
    th, td { padding: 8px; }
    input, button { margin: 4px; }
  </style>
</head>
<body>
  <h1>Food ç®¡ç†</h1>

  <h2>â• æ–°å¢é£Ÿç‰©</h2>
  <form id="addForm">
    <input type="text" name="name" placeholder="Name" required>
    <input type="number" step="0.01" name="calories" placeholder="Calories" required>
    <input type="number" step="0.01" name="protein" placeholder="Protein" required>
    <input type="number" step="0.01" name="fat" placeholder="Fat" required>
    <input type="number" step="0.01" name="carbs" placeholder="Carbs" required>
    <button type="submit">æ–°å¢</button>
  </form>
  
  <h2>ğŸ” æœå°‹é£Ÿç‰©ï¼ˆä¾åç¨±ï¼‰</h2>
  <form id="searchForm">
    <input type="text" id="searchInput" placeholder="è¼¸å…¥é£Ÿç‰©åç¨±" required>
    <button type="submit">æœå°‹</button>
    <button type="button" onclick="loadFoods()">é¡¯ç¤ºå…¨éƒ¨</button>
  </form>

  <hr>

  <h2>ğŸ“‹ ç¾æœ‰é£Ÿç‰©è³‡æ–™</h2>
  <table id="foodsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Calories</th>
        <th>Protein</th>
        <th>Fat</th>
        <th>Carbs</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      <!-- JavaScript å‹•æ…‹æ’å…¥è³‡æ–™ -->
    </tbody>
  </table>

  <script>
    const apiBase = '/foods';

    // è¼‰å…¥æ‰€æœ‰é£Ÿç‰©
    async function loadFoods() {
      try {
        const res = await fetch(apiBase);
        const foods = await res.json();
        renderTable(foods);
      } catch (err) {
        alert('âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™');
      }
    }

    // æ¸²æŸ“è¡¨æ ¼è³‡æ–™
    function renderTable(foods) {
      const tbody = document.querySelector('#foodsTable tbody');
      tbody.innerHTML = '';
      foods.forEach(f => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${f.id}</td>
          <td><input type="text" value="${f.name}" data-field="name" data-id="${f.id}"></td>
          <td><input type="number" step="0.01" value="${f.calories}" data-field="calories" data-id="${f.id}"></td>
          <td><input type="number" step="0.01" value="${f.protein}" data-field="protein" data-id="${f.id}"></td>
          <td><input type="number" step="0.01" value="${f.fat}" data-field="fat" data-id="${f.id}"></td>
          <td><input type="number" step="0.01" value="${f.carbs}" data-field="carbs" data-id="${f.id}"></td>
          <td>
            <button onclick="updateFood(${f.id})">æ›´æ–°</button>
            <button onclick="deleteFood(${f.id})">åˆªé™¤</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // æ–°å¢é£Ÿç‰©
    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      data.calories = parseFloat(data.calories);
      data.protein = parseFloat(data.protein);
      data.fat = parseFloat(data.fat);
      data.carbs = parseFloat(data.carbs);

      try {
        const res = await fetch(apiBase, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('âœ… æ–°å¢æˆåŠŸï¼');
          e.target.reset();
          loadFoods();
        } else {
          const error = await res.json().catch(() => ({}));
          alert(`âŒ ${error.message || 'æ–°å¢å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™'}`);
        }
      } catch (err) {
        alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    });

    // æ›´æ–°é£Ÿç‰©
    async function updateFood(id) {
      const inputs = document.querySelectorAll(`[data-id="${id}"]`);
      const data = {};
      inputs.forEach(input => {
        const key = input.dataset.field;
        data[key] = input.value;
      });

      try {
        const res = await fetch(`${apiBase}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('âœ… æ›´æ–°æˆåŠŸï¼');
          loadFoods();
        } else {
          alert('âŒ æ›´æ–°å¤±æ•—');
        }
      } catch (err) {
        alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // åˆªé™¤é£Ÿç‰©
    async function deleteFood(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™ï¼Ÿ')) return;

      try {
        const res = await fetch(`${apiBase}/${id}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          alert('âœ… åˆªé™¤æˆåŠŸï¼');
          loadFoods();
        } else {
          alert('âŒ åˆªé™¤å¤±æ•—');
        }
      } catch (err) {
        alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // æœå°‹é£Ÿç‰©
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('searchInput').value.trim();
      if (!name) return;

      try {
        const res = await fetch(`${apiBase}/${encodeURIComponent(name)}`);
        if (res.ok) {
          const f = await res.json();
          renderTable([f]);
        } else {
          alert('âŒ æ‰¾ä¸åˆ°è©²é£Ÿç‰©åç¨±');
        }
      } catch (err) {
        alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    });

    // åˆå§‹è¼‰å…¥
    loadFoods();
  </script>
</body>
</html>
